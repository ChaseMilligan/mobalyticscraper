<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scraped Content</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Abel&family=Chakra+Petch:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
  <div class="container">
    <form action="" id="scrapeForm" class="search-container">
      <textarea id="summonerInput" class="search-input"
        placeholder="Chilligan#NA1, Bypolarbear#smonk, Drug Or Not#Sasky, Dlash on D#skyxe, E G G B Ø I#NA1, Shíning#NA1, Juncture#NA1">Chilligan#NA1, Bypolarbear#smonk, Drug Or Not#Sasky, Dlash on D#skyxe, E G G B Ø I#NA1, Shíning#NA1, Juncture#NA1</textarea>
      <input type="submit" class="search-button" value="Search" />
    </form>
  </div>
  <div class="loader" id="loader"></div>
  <div class="container" id="data-display">
    <div id="summoner-stats-container">
      <!-- Summoner stats will be inserted here -->
    </div>
  </div>
  <footer>
    <div class="container">
      <p>This is not endorsed by Riot Games and does not reflect the views or opinions of Riot Games or anyone officially involved in producing or managing Riot Games properties. Riot Games and all associated properties are trademarks or registered trademarks of Riot Games, Inc</p>
    </div>
  </footer>

  <script>
    function formatString(input) {
      return input.toLowerCase().replace(/#/g, '-');
    }

    function arrayDifference(sequence) {
      const toNumbers = (arr) => arr.map(item => Number(item.value));

      const winArray = sequence.filter(item => item.type === 'win');
      const lossArray = sequence.filter(item => item.type === 'loss');

      const numWinArray = toNumbers(winArray);
      const numLossArray = toNumbers(lossArray);

      const sumWins = numWinArray.reduce((acc, num) => acc + num, 0);
      const sumLosses = numLossArray.reduce((acc, num) => acc + num, 0);

      const difference = sumWins - sumLosses;

      return difference;
    }

    function convertMinutesToHoursAndMinutes(minutesArray) {
      const toNumbers = (arr) => arr.map(item => Number(item));

      const numArray = toNumbers(minutesArray);

      const totalMinutes = numArray.reduce((acc, minutes) => acc + minutes, 0);

      const hours = totalMinutes / 60;

      // Convert to string with one decimal place and remove trailing zero if needed
      const decimalHours = parseFloat(hours.toFixed(1));

      return `${decimalHours} hr(s)`;
    }

    function addNumberSuffix(number) {
      const suffix = (num) => {
        if (num % 100 >= 11 && num % 100 <= 13) {
          return 'th';
        }
        switch (num % 10) {
          case 1: return 'st';
          case 2: return 'nd';
          case 3: return 'rd';
          default: return 'th';
        }
      };

      const result = `${number}${suffix(number)}`;

      return result;
    }

    async function fetchSummonerData(summoner) {
      const response = await fetch(`https://mobalyticscraper.loca.lt/api/data?url=${summoner}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'bypass-tunnel-reminder': 'yes'
        },
      
      });
      return await response.json();
    }

    async function handleFormSubmit(event) {
      event.preventDefault();
      const loader = document.getElementById('loader');
      const dataDisplay = document.getElementById('data-display');
      const summonerStatsContainer = document.getElementById('summoner-stats-container');

      dataDisplay.classList.remove('show');

      const summoners = document.getElementById('summonerInput').value.split(',').map(formatString);
      if (summoners.length === 0) {
        alert('Please enter at least one summoner name');
        return;
      }

      try {
        loader.classList.add('show');
        summonerStatsContainer.innerHTML = ''; // Clear previous results

        const allData = [];

        for (const summoner of summoners) {
          const data = await fetchSummonerData(summoner);
          const netLP = arrayDifference(data.sequence);
          const totalTime = data.times.reduce((acc, time) => acc + Number(time), 0);
          allData.push({ summoner, data, netLP, totalTime });
        }

        allData.sort((a, b) => {
          if (a.totalTime === 0 && b.totalTime === 0) return 0;
          if (a.totalTime === 0) return 1;
          if (b.totalTime === 0) return -1;
          if (b.netLP !== a.netLP) return b.netLP - a.netLP;
          return a.totalTime - b.totalTime;
        });

        let i = 1;

        allData.forEach(({ summoner, data, netLP, totalTime }) => {
          const summonerName = summoner.replace(/-/g, '#').toUpperCase();

          const summonerSection = document.createElement('div');
          summonerSection.classList.add('summoner-section');

          const sequenceList = document.createElement('ul');
          sequenceList.classList.add('sequence-list');

          data.sequence.forEach((item, index) => {
            const sequenceItem = document.createElement('li');
            sequenceItem.textContent = `${item.type == 'win' ? '+' : '-'}${item.value}`;
            sequenceItem.classList.add(item.type);
            sequenceList.appendChild(sequenceItem);
          });

          const timesList = document.createElement('ul');
          timesList.classList.add('times-list');

          data.times.forEach((time, index) => {
            const timesItem = document.createElement('li');
            timesItem.textContent = `${time}m`;
            timesItem.classList.add('time');
            timesList.appendChild(timesItem);
          });

          const timeSpent = totalTime > 0 ? convertMinutesToHoursAndMinutes(data.times) : 'No time spent';
          const netLPString = netLP >= 0 ? `+${netLP}` : `${netLP}`;

          summonerSection.innerHTML = `
            <div class="summoner-card">
              ${i === 1 ? '<img class="summoner-icon-border first" src="https://media.discordapp.net/attachments/1218314154721673248/1259209778065051790/first.png?ex=668ad9fe&is=6689887e&hm=18785fb3808036ce3318d25a87a53b941f9f0738fc2436ce947a469931b4214a&=&format=webp&quality=lossless" />' : ''}
              ${i === 2 ? '<img class="summoner-icon-border first" src="https://media.discordapp.net/attachments/1218314154721673248/1259209778375163934/second.png?ex=668ad9fe&is=6689887e&hm=4fdbe6e61480940ca45044b06f12bd42e481ca56f40cb9b50a857b7b00f097e5&=&format=webp&quality=lossless" />' : ''}
              ${i === 3 ? '<img class="summoner-icon-border first" src="https://media.discordapp.net/attachments/1218314154721673248/1259209778631151626/third.png?ex=668ad9fe&is=6689887e&hm=b665616f48d0e914afe809368744a2f063ed9ed113582586ccd1f701858c772b&=&format=webp&quality=lossless" />' : ''}
              <img src="${data.pfpUrl}" alt="${summonerName}" class="summoner-icon" />
              <div class="summoner-card-content">
                <h2>${i === 1 || i === 2 || i === 3 ? '' : `${addNumberSuffix(i)}  `}${summonerName}</h2>
                <p class="time-spent"><span>${timeSpent}</span></p>
                <div class="row">
                  <p class="elpee chakra"><span style="color: ${netLP >= 0 ? 'green' : 'red'};">${netLPString}</span> LP</p>
                  <div class="rank-info">
                    <img src="${data.rankID.iconUrl}" alt="${data.rankID.rank}" class="rank-icon"/>
                    <p class="tier chakra">${data.rankID.rank}</p>
                  </div>
                </div>
                <div class="row">
                  ${sequenceList.outerHTML}
                </div>
                <div class="row">
                  ${timesList.outerHTML}
                </div>
              </div>
            </div>
          `;

          summonerStatsContainer.appendChild(summonerSection);
          i++;
        });

        loader.classList.remove('show');
        dataDisplay.classList.add('show');
      } catch (error) {
        loader.classList.remove('show');
        console.error('Error fetching data:', error);
      }
    }

    document.getElementById('scrapeForm').addEventListener('submit', handleFormSubmit);
  </script>
</body>

</html>
