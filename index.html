<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scraped Content</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div class="container">
    <form action="" id="scrapeForm" class="search-container">
      <textarea id="summonerInput" class="search-input"
        placeholder="Chilligan#NA1, Bypolarbear#smonk, Drug Or Not#Sasky, Dlash on D#skyxe, E G G B Ø I#NA1, Shíning#NA1, Juncture#NA1">Chilligan#NA1,Bypolarbear#smonk,Drug Or Not#Sasky,Dlash on D#skyxe,E G G B Ø I#NA1,Shíning#NA1,Juncture#NA1</textarea>
      <input type="submit" class="search-button" value="Search" />
    </form>
  </div>
  <div class="loader" id="loader"></div>
  <div class="container" id="data-display">
    <div id="summoner-stats-container">
      <!-- Summoner stats will be inserted here -->
    </div>
  </div>

  <script>
    function formatString(input) {
      return input.toLowerCase().replace(/#/g, '-');
    }

    function arrayDifference(arr1, arr2) {
      const toNumbers = (arr) => arr.map(item => Number(item));

      const numArray1 = toNumbers(arr1);
      const numArray2 = toNumbers(arr2);

      const sum1 = numArray1.reduce((acc, num) => acc + num, 0);
      const sum2 = numArray2.reduce((acc, num) => acc + num, 0);

      const difference = sum1 - sum2;

      return difference;
    }

    function convertMinutesToHoursAndMinutes(minutesArray) {
      const toNumbers = (arr) => arr.map(item => Number(item));

      const numArray = toNumbers(minutesArray);

      const totalMinutes = numArray.reduce((acc, minutes) => acc + minutes, 0);

      const hours = Math.floor(totalMinutes / 60);
      const minutes = totalMinutes % 60;

      return `${hours} hour(s) and ${minutes} minute(s)`;
    }

    function addNumberSuffix(number) {
      const suffix = (num) => {
        if (num % 100 >= 11 && num % 100 <= 13) {
          return 'th';
        }
        switch (num % 10) {
          case 1: return 'st';
          case 2: return 'nd';
          case 3: return 'rd';
          default: return 'th';
        }
      };

      const result = `${number}${suffix(number)}`;

      return result;
    }

    async function fetchSummonerData(summoner) {
      const response = await fetch(`http://localhost:5000/api/data?url=${summoner}`);
      return await response.json();
    }

    async function handleFormSubmit(event) {
      event.preventDefault();
      const loader = document.getElementById('loader');
      const dataDisplay = document.getElementById('data-display');
      const summonerStatsContainer = document.getElementById('summoner-stats-container');

      dataDisplay.classList.remove('show');

      const summoners = document.getElementById('summonerInput').value.split(',').map(formatString);
      if (summoners.length === 0) {
        alert('Please enter at least one summoner name');
        return;
      }

      try {
        loader.classList.add('show');
        summonerStatsContainer.innerHTML = ''; // Clear previous results

        const allData = [];

        for (const summoner of summoners) {
          const data = await fetchSummonerData(summoner);
          const netLP = arrayDifference(data.wins, data.losses);
          const totalTime = data.times.reduce((acc, time) => acc + Number(time), 0);
          allData.push({ summoner, data, netLP, totalTime });
        }

        allData.sort((a, b) => {
          if (a.totalTime === 0 && b.totalTime === 0) return 0;
          if (a.totalTime === 0) return 1;
          if (b.totalTime === 0) return -1;
          if (b.netLP !== a.netLP) return b.netLP - a.netLP;
          return a.totalTime - b.totalTime;
        });

        let i = 1;

        allData.forEach(({ summoner, data, netLP, totalTime }) => {
          const summonerName = summoner.replace(/-/g, '#').toUpperCase();

          const summonerSection = document.createElement('div');
          summonerSection.classList.add('summoner-section');

          const winsList = document.createElement('ul');
          winsList.classList.add('list-items', 'wins');

          const lossesList = document.createElement('ul');
          lossesList.classList.add('list-items', 'losses');

          data.wins.forEach(win => {
            const listItem = document.createElement('li');
            listItem.classList.add('list-item');
            listItem.textContent = `+ ${win} LP`;
            winsList.appendChild(listItem);
          });

          data.losses.forEach(loss => {
            const listItem = document.createElement('li');
            listItem.classList.add('list-item');
            listItem.textContent = `- ${loss} LP`;
            lossesList.appendChild(listItem);
          });

          const timeSpent = totalTime > 0 ? convertMinutesToHoursAndMinutes(data.times) : 'No time spent';
          const netLPString = netLP >= 0 ? `+ ${netLP}` : `${netLP}`;

          summonerSection.innerHTML = `
            <div class="summoner-card">
              <h2>${addNumberSuffix(i)} - ${summonerName}</h2>
              <p class="time-spent">spent <span>${timeSpent}</span> grinding for <span style="color: ${netLP >= 0 ? 'green' : 'red'};">${netLPString}</span> LP</p>
              <div class="list-container">
                <div class="list-heading">Wins <span class="count">(${data.wins.length})</span></div>
                ${winsList.outerHTML}
              </div>
              <div class="list-container">
                <div class="list-heading">Losses <span class="count">(${data.losses.length})</span></div>
                ${lossesList.outerHTML}
              </div>
            </div>
          `;

          summonerStatsContainer.appendChild(summonerSection);
          i++;
        });

        loader.classList.remove('show');
        dataDisplay.classList.add('show');
      } catch (error) {
        loader.classList.remove('show');
        console.error('Error fetching data:', error);
      }
    }

    document.getElementById('scrapeForm').addEventListener('submit', handleFormSubmit);
  </script>
</body>

</html>